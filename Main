This is the main code.
Now it is slightly different.
